name: MongoDB Health Check

on:
    schedule:
        # Roda todos os dias √†s 9h UTC (6h Bras√≠lia)
        - cron: "0 9 * * *"
    workflow_dispatch:

jobs:
    health-check:
        runs-on: ubuntu-latest

        steps:
            - name: üì¶ Checkout c√≥digo
              uses: actions/checkout@v4

            - name: üü¢ Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: 20.x

            - name: üì• Instalar depend√™ncias
              working-directory: ./backend
              run: npm ci

            - name: üè• Verificar conex√£o MongoDB
              working-directory: ./backend
              run: |
                  node -e "
                  const mongoose = require('mongoose');

                  mongoose.connect('${{ secrets.MONGODB_URI }}', {
                    serverSelectionTimeoutMS: 5000
                  })
                  .then(() => {
                    console.log('‚úÖ MongoDB Atlas conectado com sucesso');
                    console.log('üìä Database:', mongoose.connection.name);
                    process.exit(0);
                  })
                  .catch(err => {
                    console.error('‚ùå Erro ao conectar MongoDB:', err.message);
                    process.exit(1);
                  });
                  "

            - name: üìä Estat√≠sticas do banco
              if: success()
              working-directory: ./backend
              run: |
                  node -e "
                  const mongoose = require('mongoose');

                  mongoose.connect('${{ secrets.MONGODB_URI }}')
                  .then(async () => {
                    const collections = await mongoose.connection.db.listCollections().toArray();
                    console.log('üìã Collections dispon√≠veis:');
                    for (const col of collections) {
                      const count = await mongoose.connection.db.collection(col.name).countDocuments();
                      console.log(\`   ‚Ä¢ \${col.name}: \${count} documentos\`);
                    }
                    process.exit(0);
                  })
                  .catch(err => {
                    console.error('‚ùå Erro:', err.message);
                    process.exit(1);
                  });
                  "

            - name: üîî Notificar erro no Pulse
              if: failure()
              run: |
                  curl -X POST ${{ secrets.PULSE_WEBHOOK_URL }}/notifications \
                       -H "Content-Type: application/json" \
                       -H "Authorization: Bearer ${{ secrets.AVILA_API_KEY }}" \
                       -d '{
                         "type": "system_alert",
                         "severity": "high",
                         "title": "MongoDB Health Check Failed",
                         "message": "A verifica√ß√£o de sa√∫de do MongoDB falhou para gabriela",
                         "source": "github-actions"
                       }'
