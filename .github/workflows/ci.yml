name: CI - Testes Backend

on:
  pull_request:
    branches:
      - main
    paths:
      - 'backend/**'
  push:
    branches:
      - develop
    paths:
      - 'backend/**'

jobs:
  test:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [18.x, 20.x]

    steps:
      - name: ğŸ“¦ Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'
          cache-dependency-path: backend/package-lock.json

      - name: ğŸ“¥ Instalar dependÃªncias
        working-directory: ./backend
        run: npm ci

      - name: ğŸ” Lint do cÃ³digo
        working-directory: ./backend
        run: npm run lint || echo "âš ï¸ Lint nÃ£o configurado ainda"

      - name: ğŸ§ª Executar testes
        working-directory: ./backend
        run: npm test || echo "âš ï¸ Testes nÃ£o configurados ainda"
        env:
          NODE_ENV: test
          MONGODB_URI: ${{ secrets.MONGODB_TEST_URI }}
          JWT_SECRET: test_secret_key

      - name: ğŸ“Š Verificar build
        working-directory: ./backend
        run: node -e "console.log('âœ… Sintaxe do cÃ³digo verificada')"

  security:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¦ Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.x

      - name: ğŸ”’ Audit de seguranÃ§a
        working-directory: ./backend
        run: npm audit --audit-level=moderate || true

      - name: ğŸ“‹ Verificar vulnerabilidades crÃ­ticas
        working-directory: ./backend
        run: |
          AUDIT_RESULT=$(npm audit --json)
          CRITICAL=$(echo $AUDIT_RESULT | jq '.metadata.vulnerabilities.critical')
          HIGH=$(echo $AUDIT_RESULT | jq '.metadata.vulnerabilities.high')

          if [ "$CRITICAL" -gt "0" ] || [ "$HIGH" -gt "0" ]; then
            echo "âš ï¸ Vulnerabilidades encontradas: $CRITICAL crÃ­ticas, $HIGH altas"
            npm audit
          else
            echo "âœ… Nenhuma vulnerabilidade crÃ­tica encontrada"
          fi
