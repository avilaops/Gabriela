name: Deploy Full Stack

on:
    push:
        branches:
            - main
    workflow_dispatch:

permissions:
    contents: read
    packages: write
    pages: write
    id-token: write

jobs:
    deploy-backend:
        name: ğŸ”§ Backend (GitHub Container)
        runs-on: ubuntu-latest
        permissions:
            contents: read
            packages: write

        steps:
            - name: ğŸ“¦ Checkout cÃ³digo
              uses: actions/checkout@v4

            - name: ğŸ³ Login no GitHub Container Registry
              uses: docker/login-action@v3
              with:
                  registry: ghcr.io
                  username: ${{ github.actor }}
                  password: ${{ secrets.GITHUB_TOKEN }}

            - name: ğŸ—ï¸ Build e Push da imagem Docker
              working-directory: ./backend
              run: |
                  IMAGE_TAG=ghcr.io/${{ github.repository }}/backend
                  docker build -t ${IMAGE_TAG}:${{ github.sha }} \
                               -t ${IMAGE_TAG}:latest .
                  docker push ${IMAGE_TAG}:${{ github.sha }}
                  docker push ${IMAGE_TAG}:latest

            - name: âœ… Backend Deploy
              run: echo "âœ… Backend image published to ghcr.io"

    deploy-frontend:
        name: ğŸ¨ Frontend (GitHub Pages)
        runs-on: ubuntu-latest
        permissions:
            contents: read
            pages: write
            id-token: write
        environment:
            name: github-pages
            url: ${{ steps.deployment.outputs.page_url }}

        steps:
            - name: ğŸ“¦ Checkout
              uses: actions/checkout@v4

            - name: ğŸ”§ Setup Pages
              uses: actions/configure-pages@v4

            - name: ğŸ“¤ Upload artifact
              uses: actions/upload-pages-artifact@v3
              with:
                  path: "."

            - name: ğŸš€ Deploy to GitHub Pages
              id: deployment
              uses: actions/deploy-pages@v4

            - name: âœ… Frontend Deploy
              run: echo "âœ… Frontend deployed to https://gabriela.avila.inc"

    summary:
        name: ğŸ“‹ Deploy Summary
        needs: [deploy-backend, deploy-frontend]
        runs-on: ubuntu-latest
        steps:
            - name: ğŸ‰ Success
              run: |
                  echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                  echo "ğŸ‰ gabriela - DEPLOY COMPLETO"
                  echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                  echo ""
                  echo "ğŸ³ Backend:  ghcr.io/${{ github.repository }}/backend:${{ github.sha }}"
                  echo "âœ… Frontend: https://gabriela.avila.inc"
                  echo ""
                  echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
